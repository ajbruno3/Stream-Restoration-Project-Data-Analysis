---
title: "Project Data Analysis"
author: "Anthony Bruno"
date: "2023-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
```

Load raw Data
```{r}
# Specify the file path to your CSV file
file_path <- "rawdata.csv"

# Read the CSV file and create a data frame
streamData <- read.csv(file_path)
```

Visualize the data:
 
Look at Total N First:

Look at Total N vs. Treatment Type
```{r}
ggplot(data = streamData, aes(x= Type, y = Total.N)) +
  stat_boxplot() + 
  ggtitle("Total N for each treatment")
```
Plot of Total N vs. Distance from Stream Bank
```{r}
ggplot( data = streamData, aes( x = Distance, y = Total.N, color = Type, shape = Type)) + 
  geom_point() +
  ggtitle("Total N vs. Distance from Stream Bank") +
  theme_minimal()
```
Box plots of Total N for each type at each distance
```{r}
ggplot(streamData, aes( y = Total.N, fill = Type)) +
  geom_boxplot() +
  facet_wrap(~ Distance, nrow = 1) +
  labs( x = "Distance from stream bank") +
  theme(axis.text.x = element_blank()) +
  ggtitle("Total N concentrations at Each Distance")
 
```
Now look at Inorganic N:

Total Inorganic N concentrations for each Treatment Type
```{r}
ggplot(data = streamData, aes(x= Type, y = Inorg.N)) +
  stat_boxplot() + 
  ggtitle("Inorganic N for each treatment")
```

Plot of Inorganic N vs distance colored by treatment type
```{r}
ggplot( data = streamData, aes( x = Distance, y = Inorg.N, color = Type)) + 
  geom_point() +
  ggtitle("Inorganic N vs. Distance from Stream Bank")
```
Box plot of Inorganic N vs Treatment type at each distance
```{r}
ggplot(streamData, aes( y = Inorg.N, fill = Type)) +
  geom_boxplot() +
  facet_wrap(~ Distance, nrow = 1) +
  labs( x = "Distance from stream bank") +
  theme(axis.text.x = element_blank()) +
  ggtitle("Inorganic N concentrations at Each Distance")
```
Now lets do some Bootstrapping Statistics:

Compare Total N Concentration for CSS vs non-CSS:

Create function to calculate and store resampled differences
```{r}
resampled_diff <- function(thisStreamData) {
  # Resample the response variable with replace = TRUE
  thisStreamData$resampledResponse <- sample(thisStreamData$Total.N, replace = TRUE)
  
  # Create a new data frame to store the resampled results
  resampled_data <- data.frame(Type = thisStreamData$Type, resampledResponse = thisStreamData$resampledResponse)
  
  # Calculate the sum of Total N for each treatment type in the resampled data
  summed_data <- resampled_data %>%
    group_by(Type) %>%
    summarize(tot_n = sum(resampledResponse))
  
  # Calculate the difference in total N for each treatment type
  diff_data <- summed_data %>%
    mutate(tot_n_diff = diff(tot_n))
  
  return(diff_data$tot_n_diff[1])
}

# Replicate the function and store the differences
num_replications <- 1000  # Change this to the desired number of replications

resampled_differences <- replicate(num_replications, resampled_diff(streamData))

```

Create distribution of Tot N differences (should be approximately normal)
```{r}
hist(resampled_differences)
```
Find Probablility of difference greater than or equal too observed_diff
```{r}
observed_diff <- 120
mean(resampled_differences > observed_diff)
```

Look at the probability that there is a linear relationship between all TOTAL NITROGEN samples with respect to DISTANCE from stream bank:

Function for resampling and fitting a linear relationship to the data
```{r}
resampleAndFit_totn_dist=function(thisStreamData){
  #within the function, streamData does not exist, but thisStreamData does
  
  #resample the response variable with replace = true
  thisStreamData$resampledResponse=sample(thisStreamData$Total.N,replace=T)
  
  #fit a lm to the resampled dataset, save it as resampleFit
  resampleFit_totn_dist=lm(thisStreamData$resampledResponse~thisStreamData$Distance)
  
  #points or fitted lines representing the resampled data can be added to the plot by uncommenting out these lines:
  #points(resampledResponse~thisStreamData$Distance,pch=2)
  #abline(resampleFit)
  
  #return the slope coefficient
 return(resampleFit_totn_dist$coefficients[[2]])
}

```

Resample the random slopes XXX times
```{r}
resampledSlopes_totn_dist=replicate(100,resampleAndFit_totn_dist(streamData))
```

Look at the distribution of the resampled slopes:
```{r}
hist(resampledSlopes_totn_dist)
```

Check that the resampledSlopes are close to 0.I f it's not, something is wrong
```{r}
mean(resampledSlopes_totn_dist)
```

P-value that that there is a linear relationship between Total N and distance from the stream channel with a slope of
```{r}
mean(resampledSlopes_totn_dist> 0.2)
```

Look at the probability that there is a linear relationship between all Inorganic Nitrogen samples with respect to DISTANCE from stream bank:

Function for resampling and fitting a linear relationship to the data
```{r}
resampleAndFit_inorgn_dist=function(thisStreamData){
  #within the function, streamData does not exist, but thisStreamData does
  
  #resample the response variable with replace = true
  thisStreamData$resampledResponse=sample(thisStreamData$Inorg.N,replace=T)
  
  #fit a lm to the resampled dataset, save it as resampleFit
  resampleFit_inorgn_dist=lm(thisStreamData$resampledResponse~thisStreamData$Distance)
  
  #points or fitted lines representing the resampled data can be added to the plot by uncommenting out these lines:
  #points(resampledResponse~thisStreamData$Distance,pch=2)
  #abline(resampleFit)
  
  #return the slope coefficient
 return(resampleFit_inorgn_dist$coefficients[[2]])
}

```

Resample the random slopes XXX times
```{r}
resampledSlopes_inorgn_dist=replicate(100,resampleAndFit_inorgn_dist(streamData))
```

Look at the distribution of the resampled slopes:
```{r}
hist(resampledSlopes_inorgn_dist)
```
Check that the resampledSlopes are close to 0.If it's not, something is wrong
```{r}
mean(resampledSlopes_inorgn_dist)
```

P-value that that there is a linear relationship between Total N and distance from the stream channel with a slope of
```{r}
mean(resampledSlopes_inorgn_dist> 0.2)
```


Look at the probability that there is a linear relationship between all Total Nitrogen samples with resepect to Relative Elevation above the WSE:

function for resampling and fitting the data
```{r}
resampleAndFit_totn_Elev=function(thisStreamData){
  #within the function, streamData does not exist, but thisStreamData does
  
  #resample the response variable with replace = true
  thisStreamData$resampledResponse=sample(thisStreamData$Total.N,replace=T)
  
  #fit a lm to the resampled dataset, save it as resampleFit
  resampleFit_totn_Elev=lm(thisStreamData$resampledResponse~thisStreamData$Relative.Elev.)
  
  #points or fitted lines representing the resampled data can be added to the plot by uncommenting out these lines:
  #points(resampledResponse~thisStreamData$Distance,pch=2)
  #abline(resampleFit)
  
  #return the slope coefficient
 return(resampleFit_totn_Elev$coefficients[[2]])
}

```

```{r}
resampledSlopes_totn_Elev=replicate(100,resampleAndFit_totn_Elev(streamData))
```

```{r}
hist(resampledSlopes_totn_Elev)
```

```{r}
mean(resampledSlopes_totn_Elev)
```
Find Probability of linear realation btw nutrients and elevation with a slipe of XXX
```{r}
mean(resampledSlopes_totn_Elev> 0.2)
```

Look at the probability that there is a linear relationship between all Inorganic Nitrogen samples with respect to Relative Elevation above the WSE:

function for resampling and fitting the data
```{r}
resampleAndFit_inorgn_Elev=function(thisStreamData){
  #within the function, streamData does not exist, but thisStreamData does
  
  #resample the response variable with replace = true
  thisStreamData$resampledResponse=sample(thisStreamData$Inorg.N,replace=T)
  
  #fit a lm to the resampled dataset, save it as resampleFit
  resampleFit_inorgn_Elev=lm(thisStreamData$resampledResponse~thisStreamData$Relative.Elev.)
  
  #points or fitted lines representing the resampled data can be added to the plot by uncommenting out these lines:
  #points(resampledResponse~thisStreamData$Distance,pch=2)
  #abline(resampleFit)
  
  #return the slope coefficient
 return(resampleFit_inorgn_Elev$coefficients[[2]])
}

```

```{r}
resampledSlopes_inorgn_Elev=replicate(100,resampleAndFit_inorgn_Elev(streamData))
```

```{r}
hist(resampledSlopes_inorgn_Elev)
```

```{r}
mean(resampledSlopes_inorgn_Elev)
```
```{r}
mean(resampledSlopes_inorgn_Elev> 0.2)
```


Look at the probability that there is a difference between the average elevation above the Thalweg for the two treatments:
```{r}
resampled_avgelev_diff <- function(thisStreamData) {
 
    # Resample the response variable with replace = TRUE
  thisStreamData$resampled_elev <- sample(thisStreamData$Relative.Elev., replace = TRUE)
  
  # Create a new data frame to store the resampled results
  resampled_elev_data <- data.frame(Type = thisStreamData$Type, resampledResponse = thisStreamData$resampled_elev)
  
  # Calculate the average elevation above the WSE for each treatment type in the resampled data
  summed_data <- resampled_elev_data %>%
    group_by(Type) %>%
    summarize(avg_elev = mean(resampledResponse))
  
  # Calculate the difference in average elevation for each treatment type
  diff_data <- summed_data %>%
    mutate(avg_elev_diff = (diff(avg_elev)))  # added a default value for the first difference
  
  return(diff_data$avg_elev_diff[1])
}
# Replicate the function and store the differences
num_replications <- 10000  # Change this to the desired number of replications

resampled_elev_differences <- replicate(num_replications, resampled_avgelev_diff(streamData))
```

Create distribution of Average Elev. Differences (should be approximately normal)
```{r}
hist(resampled_elev_differences)
```

Find Probability of differences greater than or equal too observed_elev_diff
```{r}
observed_elev_diff <- streamData %>%
  group_by(Type) %>%
  summarize(avg_elev = mean(Relative.Elev.)) %>%
  summarize(observed_elev_diff = diff(avg_elev))

message("The observed average elevation difference between the thalweg and soil sample locations for transects with channel spanning structures vs. without is ", observed_elev_diff$observed_elev_diff, " feet")

mean(resampled_elev_differences > observed_elev_diff$observed_elev_diff)

```